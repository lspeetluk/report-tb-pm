---
title: "TB PM Secondary Outcomes"
author: "Lauren Saag Peetluk"
date: "`r Sys.Date()`"
output:
   
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    number_section: false
    toc_float:
      collapsed: true
    theme: simplex
    code_folding: hide
  pdf_document:
    keep_tex: true
---


```{r setup, include=FALSE, echo=FALSE, message=FALSE}
# Required packages
library(Hmisc)
library(rms)
library(kableExtra)
library(tidyverse)
library(here)
library(gmodels)
library(gtsummary) 
library(glmnet)
library(cowplot)
library(hrbrthemes)
library(pROC)
library(ResourceSelection)


# Global options
options(prType='plain')
options(digits=3)
knitrSet(lang='markdown', h=6, w=6)

knitr::opts_chunk$set(
  fig.path = "images/", 
  cache.path = 'cache/images-',
  fig.align = "center",
  warning = FALSE,
  message = FALSE,
  rows.print=30,
  cols.print=15
)

# gtsmmary options
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 'small', data_row.padding = gt::px(1))")
```

`r hidingTOC(buttonLabel="Outline", levels=2)`

```{r}
# Load datasets
load(file="/Users/Lauren/Box/RePORT Brazil/Datasets/Save/imputed_analysis_data.Rdata") # mi_sum dataset based on summarized imputation
load(file="/Users/Lauren/Box/RePORT Brazil/Datasets/Save/report_dissertation_lsp.Rdata") # original data with missing 

# Load files from last run
# load(file="/Users/Lauren/Box/RePORT Brazil/Datasets/Save/tb_models_files")

# Load functions
source(here("Manuscript", "manuscript_functions.R"))

# Set data distribution
dd <- datadist (mi_sum)
options(datadist="dd")
```


```{r}
# Seed for all analyses
SEED = 1408

# Save outcome vector from mi_sum
outcome_vector <- mi_sum$unsuccessful

# RCS model formula 
model_form_rcs <- as.formula(unsuccessful ~ hiv + diabetes_yn + rcs(lab_hgb,4) + evertb + xray_cavit + smear_pos + rcs(age,4) + female + rcs(bmi,4) + dishx_any_minus + rcs(educ_years,4) + alcoholhx + drughx + smokhx + non_white)

```


## Biologic outcomes (death, failure, regimen switch)

This analysis will exclude people who did not complete treatment or were LTF (not evaluated)

```{r}
biologic <- mi_sum %>% filter(outcome_cat!="Treatment incomplete" & outcome_cat!="Not evaluated")

biologic %>% 
  tbl_cross(row=outcome_cat,
            col=unsuccessful,
            perc = "col")

full_model_bio <- lrm(model_form_rcs, data=biologic, x=TRUE, y=TRUE)
anova(full_model_bio)
```

BMI needs rcs - will use BMI categories

```{r, cache=TRUE}
biologic <- biologic %>% 
  mutate(bmi_cat = case_when(
    bmi>=18.5 & bmi<25 ~ "Normal",
    bmi<18.5 ~ "Under",
    bmi>=25 ~ "Over", 
    TRUE ~ NA_character_))

biologic %>% 
  group_by(bmi_cat) %>% 
  summarize(min_bmi = min(bmi),
            max_bmi = max(bmi))
         
model_formula_bio <- as.formula(unsuccessful ~ hiv + diabetes_yn + lab_hgb + evertb + xray_cavit + 
    smear_pos + age + female + bmi_cat + dishx_any_minus + 
    educ_years + alcoholhx + drughx + smokhx + non_white)

approx_full_form_bio <- as.formula(predvals_full_model ~ hiv + diabetes_yn + lab_hgb + evertb + 
    xray_cavit + smear_pos + age + female + bmi_cat + dishx_any_minus + 
    educ_years + alcoholhx + drughx + smokhx + non_white)

set.seed(SEED)
seed=SEED

# Set data distribution
dd <- suppressWarnings(datadist(biologic))
options(datadist="dd")

save_results_biologic <- model_development(data=biologic, 
                                  outcome=biologic$unsuccessful, 
                                  model_formula=model_formula_bio, 
                                  approx_full_formula=approx_full_form_bio, 
                                  bootstraps=200, 
                                  seed=SEED)
```

### Bootstrap resampling

The table below shows the model coefficients from the full model, the selected model, and the bootstrap resampled model. In addition it quantifies how often variables were included in 200 bootstrap samples and their RMSD. These are explained well in the tb_pm_development file. 

```{r}
save_results_biologic$formatted_overview
```

### Model coefficients

The table below compares the coefficients via the different methods for model selection. It is really just a simplification of the above table. 

```{r}
save_results_biologic$coefficients_table
```

### Model performance

```{r}
save_results_biologic$models_performance

```


### Internal validation 

Here are the estimated c-statisitcs from the full model and the model including only variables that were selected in at least 50% of the bootstrap resamples. 

```{r}
save_results_biologic$c_statistics
```

### Calibration

Below is the calibration plot from the model developed using the variables that were selected in at least 50% of the bootstrap resamples.

```{r}
save_results_biologic$boot50_calibration
```

### Model approximation 

The boot50 model approximates the predicted values from the full model with an R2 of: 

```{r}
save_results_biologic$r2_approx
```

### ROC curve 

This is the ROC curve based on the predicted values from the boot50 model, but shrunk by the heuristic shrinkage factor to account for overfitting. 

```{r}
save_results_biologic$roc_shrink
plot(save_results_biologic$roc_shrink)
```

The AUC from that model is consistent with the AUC from the boot50 model.

### Boot medians

As a refresher, here are the coefficients from that procedure:

```{r}
# Boot50 medians
boot_medians_bio <- save_results_biologic$raw_overview[,"boot_median"][which(save_results_biologic$raw_overview[,"boot_median"]!=0)]
names_boot_medians_bio <- names(boot_medians_bio)

boot_medians_bio
```


```{r}
mi_sum <- mi_sum %>% 
  mutate(predvals_boot_median_bio = 
           -0.442 +
           1.167*hiv +
           1.044*diabetes_yn +
           -0.245*lab_hgb +
           -0.880*evertb +
           0.019*age +
           0.593*smear_pos,
         predrisk_boot_median_bio = 1/(1+exp(-predvals_boot_median_bio))
         )

mi_sum %>% 
  select(predvals_boot_median_bio, predrisk_boot_median_bio, unsuccessful) %>% 
  tbl_summary(by="unsuccessful")
```


#### Performance 

Brier score, calibration slope, and calibration intercept of the full model:
 
```{r}
boot_med_bio_perf <- ev_glm(method="original", lp="predvals_boot_median_bio", outcome="unsuccessful", data=mi_sum, samples=200, return="performance")

brier <- boot_med_bio_perf["Brier", "apparent"]
slope <- boot_med_bio_perf["Slope", "apparent"]
intercept <- boot_med_bio_perf["Intercept", "apparent"]

perf_boot_median_bio <- rbind("Brier score" = brier, "Calibration slope" = slope, "Calibration intercept" = intercept)
perf_boot_median_bio
```


CI for apparent c-statistic 

```{r}
predvals_boot_median_bio = mi_sum$predvals_boot_median_bio

c_boot_median_bio <- c_ci(predvals_boot_median_bio, outcome_vector)
c_boot_median_bio
```


#### Calibration plot

```{r}
cal_plot_solo(mi_sum, predvals_boot_median_bio, outcome_vector)
```

#### ROC curve 

```{r}
plot(ev_glm(method="original", lp="predvals_boot_median_bio", outcome="unsuccessful", data=mi_sum, samples=1, return="roc"))
```



## Behavioral outcomes (treatment incomplete, not evaluated)

```{r}
behavioral <- mi_sum %>% filter(outcome_cat!="Death" & outcome_cat!="Treatment failure" & outcome_cat!="Regimen switch")

behavioral %>% 
  tbl_cross(row=outcome_cat,
            col=unsuccessful,
            perc = "col")

full_model_behav <- lrm(model_form_rcs, data=behavioral, x=TRUE, y=TRUE)
anova(full_model_behav)
```

No non-linear terms are needed


```{r, cache=TRUE}
model_formula_behav <- as.formula(unsuccessful ~ hiv + diabetes_yn + lab_hgb + evertb + xray_cavit + 
    smear_pos + age + female + bmi + dishx_any_minus + 
    educ_years + alcoholhx + drughx + smokhx + non_white)

approx_full_form_behav <- as.formula(predvals_full_model ~ hiv + diabetes_yn + lab_hgb + evertb + 
    xray_cavit + smear_pos + age + female + bmi + dishx_any_minus + 
    educ_years + alcoholhx + drughx + smokhx + non_white)


set.seed(SEED)
seed=SEED

# Set data distribution
dd <- suppressWarnings(datadist(behavioral))
options(datadist="dd")

save_results_behavioral <- model_development(data=behavioral, 
                                  outcome=behavioral$unsuccessful, 
                                  model_formula=model_formula_behav, 
                                  approx_full_formula=approx_full_form_behav, 
                                  bootstraps=200, 
                                  seed=SEED)

```

### Bootstrap resampling

The table below shows the model coefficients from the full model, the selected model, and the bootstrap resampled model. In addition it quantifies how often variables were inclued in 200 bootstrap resamples and their RMSD. These are explained well in the tb_pm_development file. 

```{r}
save_results_behavioral$formatted_overview
```

### Model coefficients

The table below compares the coefficients via the different methods for model selection. It is really just a simplication of the above table. 

```{r}
save_results_behavioral$coefficients_table
```


### Model performance

```{r}
save_results_behavioral$models_performance

```


### Internal validation 

Here are the estimated c-statistics from the full model and the model including only variables that were selected in at least 50% of the bootstrap resamples:

```{r}
save_results_behavioral$c_statistics
```

### Calibration 

Below is the calibration plot from the model developed using the variables that were selected in at least 50% of the bootstrap resamples.

```{r}
save_results_behavioral$boot50_calibration
```


### Model approximation 

The boot50 model approximates the predicted values from the full model with an R2 of: 

```{r}
save_results_behavioral$r2_approx
```

### ROC Curve 

This is the ROC curve based on the predicted values from the boot50 model, but shrunk by the heuristic shrinkage factor to account for overfitting. 

```{r}
save_results_behavioral$roc_shrink
plot(save_results_behavioral$roc_shrink)
```

The AUC from that model is consistent with the AUC from the boot50 model. 
Note: the selected model / shrunk coefficients for the AUC curve does not include diabetes, but the boot50 model does. 


### Boot medians

As a refresher, here are the coefficients from that procedure:

```{r}
# Boot50 medians
boot_medians_behav <- save_results_behavioral$raw_overview[,"boot_median"][which(save_results_behavioral$raw_overview[,"boot_median"]!=0)]
names_boot_medians_behav <- names(boot_medians_behav)

boot_medians_behav
```


```{r}
mi_sum <- mi_sum %>% 
  mutate(predvals_boot_median_behav = 
          0.870 +
           -0.116*educ_years +
           -0.039*age +
           1.248*(drughx=="Current") +
           0.491*(drughx=="Former") +
           0.969*(smokhx=="Current") +
           1.065*(smokhx=="Former")+
           -0.121*lab_hgb +
           -0.505*female +
           -0.065*bmi +
           0.397*hiv +
           0.402*diabetes_yn +
           0.032*(alcoholhx=="Current"),
         predrisk_boot_median_behav = 1/(1+exp(-predvals_boot_median_behav))
         )

mi_sum %>% 
  select(predvals_boot_median_behav, predrisk_boot_median_behav, unsuccessful) %>% 
  tbl_summary(by="unsuccessful")
```


#### Performance 

Brier score, calibration slope, and calibration intercept of the full model:
 
```{r}
boot_med_behav_perf <- ev_glm(method="original", lp="predvals_boot_median_behav", outcome="unsuccessful", data=mi_sum, samples=200, return="performance")

brier <- boot_med_behav_perf["Brier", "apparent"]
slope <- boot_med_behav_perf["Slope", "apparent"]
intercept <- boot_med_behav_perf["Intercept", "apparent"]

perf_boot_median_behav <- rbind("Brier score" = brier, "Calibration slope" = slope, "Calibration intercept" = intercept)
perf_boot_median_behav
```


CI for apparent c-statistic 

```{r}
predvals_boot_median_behav = mi_sum$predvals_boot_median_behav

c_boot_median_behav <- c_ci(predvals_boot_median_behav, outcome_vector)
c_boot_median_behav
```


#### Calibration plot

```{r}
cal_plot_solo(mi_sum, predvals_boot_median_behav, outcome_vector)
```

#### ROC curve 

```{r}
plot(ev_glm(method="original", lp="predvals_boot_median_behav", outcome="unsuccessful", data=mi_sum, samples=1, return="roc"))
```



```{r}
save.image(file="/Users/Lauren/Box/RePORT Brazil/Datasets/Save/tb_models_files")
```


```{r}
# Save results to excel


# Biologic outcomes results
bio_overview <- save_results_biologic$raw_overview
bio_coefficients <- save_results_biologic$coefficients_table
bio_performance <- save_results_biologic$models_performance

# Behavioral outcomes results
behav_overview <- save_results_behavioral$raw_overview
behav_coefficients <- save_results_behavioral$coefficients_table
behav_performance <- save_results_behavioral$models_performance


# ---- Save to Excel --- 

library(openxlsx)

# Create a blank workbook
other_outcomes <- createWorkbook()

# Add some sheets to the workbook
addWorksheet(other_outcomes, "Biologic-Model-Selection")
addWorksheet(other_outcomes, "Biologic-Coefficients")
addWorksheet(other_outcomes, "Biologic-Performance")
addWorksheet(other_outcomes, "Behavioral-Model-Selection")
addWorksheet(other_outcomes, "Behavioral-Coefficients")
addWorksheet(other_outcomes, "Behavioral-Performance")


# Write the data to the sheets
writeData(other_outcomes, sheet = "Biologic-Model-Selection", x = bio_overview)
writeData(other_outcomes, sheet = "Biologic-Coefficients", x = bio_coefficients)
writeData(other_outcomes, sheet = "Biologic-Performance", x = bio_performance)
writeData(other_outcomes, sheet = "Behavioral-Model-Selection", x = behav_overview)
writeData(other_outcomes, sheet = "Behavioral-Coefficients", x = behav_coefficients)
writeData(other_outcomes, sheet = "Behavioral-Performance", x = behav_performance)

# Export the file
saveWorkbook(other_outcomes, here("Manuscript", "tables", "other_outcomes_results.xlsx"), overwrite=TRUE)
```

